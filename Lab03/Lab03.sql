USE master;
GO

CREATE DATABASE QLHH ON 
PRIMARY (
    NAME = QLHH_data,
    FILENAME = 'F:\projects\SQLServerLog\Lab03\Lab03.mdf',
    SIZE = 50MB,
    MAXSIZE = 200MB,
    FILEGROWTH = 10MB
)
LOG ON (
    NAME = QLHH_log,
    FILENAME = 'F:\projects\SQLServerLog\Lab03\Lab03.ldf',
    SIZE = 10MB,
    FILEGROWTH = 2MB
);
GO

USE QLHH
GO

-- VATTU
CREATE TABLE VATTU
(
	MaVTu		CHAR(4) NOT NULL,
	TenVTu		NVARCHAR(100) NOT NULL,
	DvTinh		NVARCHAR(10),
	PhanTram	REAL,
	CONSTRAINT pk_VATTU PRIMARY KEY (MaVTu),
	CONSTRAINT unique_VATTU_TenVTu UNIQUE(TenVTu)
)

ALTER TABLE VATTU
ADD
	CONSTRAINT df_VATTU_DvTinh
	DEFAULT(N'') FOR DvTinh

ALTER TABLE VATTU
ADD
	CONSTRAINT chk_VATTU_PhanTram
	CHECK (PhanTram BETWEEN 0 AND 100);

-- NHACC
CREATE TABLE NHACC
(
	MaNhaCc		CHAR(3) NOT NULL,
	TenNhaCc	NVARCHAR(100) NOT NULL,
	DiaChi		NVARCHAR(200) NOT NULL,
	DienThoai	NVARCHAR(20),
	CONSTRAINT pk_NHACC PRIMARY KEY(MaNhaCc)
)

ALTER TABLE NHACC
ADD
	CONSTRAINT df_NHACC_DienThoai
	DEFAULT(N'Chưa có') FOR DienThoai
	 
-- DONDH
CREATE TABLE DONDH
(
	SoDh		CHAR(4) NOT NULL,
	NgayDh		DATETIME,
	MaNhaCc		CHAR(3) NOT NULL
	CONSTRAINT pk_SoDh PRIMARY KEY(SoDh)
	CONSTRAINT fk_DONDH_MaNhaCc
				FOREIGN KEY(MaNhaCc)
				REFERENCES NHACC(MaNhaCc)
)

ALTER TABLE DONDH
ADD
	CONSTRAINT df_DONDH_NgayDh
	DEFAULT(GETDATE()) FOR NgayDh

-- CTDONDH
CREATE TABLE CTDONDH
(
	SoDh		CHAR(4) NOT NULL,
	MaVTu		CHAR(4) NOT NULL,
	SlDat		INT
	CONSTRAINT pk_CTDONDH PRIMARY KEY(SoDh, MaVTu),
	CONSTRAINT fk_CTDONDH_SoDh
				FOREIGN KEY(SoDh)
				REFERENCES DONDH(SoDh),
	CONSTRAINT fk_CTDONDH_MaVTu
				FOREIGN KEY(MaVTu)
				REFERENCES VATTU(MaVTu)
)

ALTER TABLE CTDONDH
ADD 
	CONSTRAINT chk_CTDONDH_SlDat
	CHECK (SlDat > 0)

-- PNHAP
CREATE TABLE PNHAP
(
	SoPn		CHAR(4),
	NgayNhap	DATETIME,
	SoDh		CHAR(4) NOT NULL,
	CONSTRAINT pk_PNHAP PRIMARY KEY(SoPn),
	CONSTRAINT fk_PNHAP_SoDh
				FOREIGN KEY(SoDh)
				REFERENCES DONDH(SoDh)
)

ALTER TABLE PNHAP
ADD 
	CONSTRAINT df_PNHAP_NgayNhap
	DEFAULT(GETDATE()) FOR NgayNhap

-- CTPNHAP
CREATE TABLE CTPNHAP
(
	SoPn		CHAR(4) NOT NULL,
	MaVTu		CHAR(4) NOT NULL,
	SlNhap		INT NOT NULL,
	DgNhap		MONEY NOT NULL,
	CONSTRAINT pk_CTPNHAP PRIMARY KEY(SoPn, MaVTu),
	CONSTRAINT fk_CTPNHAP_SoPn
				FOREIGN KEY(SoPn)
				REFERENCES PNHAP(SoPn),
	CONSTRAINT fk_CTPNHAP_MaVTu
				FOREIGN KEY(MaVTu)
				REFERENCES VATTU(MaVTu)
)

ALTER TABLE CTPNHAP
ADD
	CONSTRAINT chk_SlNhap
	CHECK (SlNhap > 0)

ALTER TABLE CTPNHAP
ADD
	CONSTRAINT chk_DgNhap
	CHECK (DgNhap > 0)

-- PXUAT
CREATE TABLE PXUAT
(
	SoPx		CHAR(4) NOT NULL,
	NgayXuat	DATETIME,
	TenKh		NVARCHAR(100) NOT NULL,
	CONSTRAINT pk_PXUAT PRIMARY KEY(SoPx)
)

ALTER TABLE PXUAT
ADD
	CONSTRAINT df_PXUAT_NgayXuat
	DEFAULT(GETDATE()) FOR NgayXuat

-- CTPXUAT
CREATE TABLE CTPXUAT
(
	SoPx		CHAR(4) NOT NULL,
	MaVTu		CHAR(4) NOT NULL,
	SlXuat		INT NOT NULL,
	DgXuat		MONEY NOT NULL,
	CONSTRAINT pk_CTPXUAT PRIMARY KEY(SoPx, MaVTu),
	CONSTRAINT fk_CTPXUAT_SoPx
				FOREIGN KEY(SoPx)
				REFERENCES PXUAT(SoPx),
	CONSTRAINT fk_CTPXUAT_MaVTu
				FOREIGN KEY(MaVTu)
				REFERENCES VATTU(MaVTu)
)

ALTER TABLE CTPXUAT
ADD
	CONSTRAINT chk_SlXuat
	CHECK (SlXuat > 0)

ALTER TABLE CTPXUAT
ADD
	CONSTRAINT chk_DgXuat
	CHECK (DgXuat > 0)

-- TONKHO
CREATE TABLE TONKHO
(
	NamThang	CHAR(6) NOT NULL,
	MaVTu		CHAR(4) NOT NULL,
	SLDau		INT NOT NULL,
	TongSLN		INT NOT NULL,
	TongSLX		INT NOT NULL,
	SLCuoi		AS (CAST(SLDau + TongSLN - TongSLX AS INT)),
	CONSTRAINT pk_TONKHO PRIMARY KEY(NamThang, MaVTu),
	CONSTRAINT fk_TONKHO_MaVTu
				FOREIGN KEY(MaVTu)
				REFERENCES VATTU(MaVTu)
)
GO

INSERT INTO NHACC
VALUES
	('C01', N'Lê Minh Thành', N'54, Kim Mã, Cầu Giấy, Hà Nội', '8781024'),
	('C02', N'Trần Quang Anh', N'145, Hùng Vương, Hải Dương', '7698154'),
	('C03', N'Bùi Hồng Phương', N'154/85, Lê Chân, Hải Phòng', '9600125'),
	('C04', N'Vũ Nhật Thắng', N'198/40 Hương Lộ 14 QTB HCM', '8757757'),
	('C05', N'Nguyễn Thị Thúy', N'178 Nguyễn Văn Luông Đà Lạt', '7964251'),
	('C07', N'Cao Minh Trung', N'125 Lê Quang Sung Nha Trang', DEFAULT);

INSERT INTO VATTU
VALUES 
	('DD01', N'Đầu DVD Hitachi 1 đĩa', N'Bộ', 40),
	('DD02', N'Đầu DVD Hitachi 3 đĩa', N'Bộ', 40),
	('TL15', N'Tủ lạnh Sanyo 150 lit', N'Cái', 25),
	('TL90', N'Tủ lạnh Sanyo 90 lit', N'Cái', 20),
	('TV14', N'Tivi Sony 14 inches', N'Cái', 15),
	('TV21', N'Tivi Sony 21 inches', N'Cái', 10),
	('TV29', N'Tivi Sony 29 inches', N'Cái', 10),
	('VD01', N'Đầu VCD Sony 1 đĩa', N'Bộ', 30),
	('VD02', N'Đầu VCD Sony 3 đĩa', N'Bộ', 30);
	
INSERT INTO DONDH
VALUES
	('D001', '2012-01-15', 'C03'),
	('D002', '2012-01-30', 'C01'),
	('D003', '2012-02-10', 'C02'),
	('D004', '2012-02-17', 'C05'),
	('D005', '2012-03-01', 'C02'),
	('D006', '2012-03-12', 'C05');

INSERT INTO PNHAP
VALUES
	('N001', '2012-01-17', 'D001'),
	('N002', '2012-01-20', 'D001'),
	('N003', '2012-01-31', 'D002'),
	('N004', '2012-02-02', 'D003');

INSERT INTO CTDONDH
VALUES
	('D001', 'DD01', 10),
	('D001', 'DD02', 15),
	('D002', 'VD02', 30),
	('D003', 'TV14', 10),
	('D003', 'TV29', 20),
	('D004', 'TL90', 10),
	('D005', 'TV14', 10),
	('D005', 'TV29', 20),
	('D006', 'TV14', 10),
	('D006', 'TV29', 20),
	('D006', 'VD01', 20);

INSERT INTO CTPNHAP
VALUES
	('N001', 'DD01', 8, 2500000),
	('N001', 'DD02', 10, 3500000),
	('N002', 'DD01', 2, 2500000),
	('N002', 'DD02', 5, 3500000),
	('N003', 'VD02', 30, 2500000),
	('N004', 'TV14', 5, 2500000),
	('N004', 'TV29', 12, 3500000);

INSERT INTO PXUAT
VALUES
	('X001', '2012-01-17', N'Nguyễn Ngọc Phương Nhi'),
	('X002', '2012-01-25', N'Nguyễn Hồng Phương'),
	('X003', '2012-01-31', N'Nguyễn Tuấn Tú');

INSERT INTO CTPXUAT
VALUES
	('X001', 'DD01', 2, 3500000),
	('X002', 'DD01', 1, 3500000),
	('X002', 'DD02', 5, 4900000),
	('X003', 'DD01', 3, 3500000),
	('X003', 'DD02', 2, 4900000),
	('X003', 'VD02', 10, 3250000);

INSERT INTO TONKHO
VALUES
	('201201', 'DD01', 0, 10, 6),
	('201201', 'DD02', 0, 15, 7),
	('201201', 'VD02', 0, 30, 10),
	('201202', 'DD01', 4, 0, 0),
	('201202', 'DD02', 8, 0, 0),
	('201202', 'VD02', 20, 0, 0),
	('201202', 'TV14', 5, 0, 0),
	('201202', 'TV29', 20, 0, 0);

